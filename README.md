# Config-control-service
# Техническое задание

## Проект: Сервис управления конфигурациями

### 1. Введение

Необходимо разработать сервис управления конфигурациями для распределённых сервисов.
Сервис должен предоставлять REST API для загрузки, получения и ведения истории конфигураций.

Цель задания — проверить:

* владение **Python** и асинхронным фреймворком (**Twisted**);
* навыки работы с **Postgres**;
* опыт сериализации/десериализации данных (**PyYAML**, **JSON**);
* умение проектировать API и архитектуру хранения;
* базовые навыки работы с **Docker**.

---

### 2. Основные требования

#### 2.1 REST API

Сервис должен предоставлять API с методами:

1. `POST /config/{service}`

   * Назначение: загрузить новую конфигурацию для сервиса.
   * Вход: тело запроса — конфигурация в формате YAML.
   * Действия:

     * проверить корректность YAML;
     * валидировать обязательные поля (например: `version`, `database.host`, `database.port`);
     * сохранить конфигурацию в базу данных как новую версию.
   * Ответ: JSON вида:

     ```json
     {
       "service": "my_service",
       "version": 3,
       "status": "saved"
     }
     ```

2. `GET /config/{service}`

   * Назначение: получить актуальную конфигурацию сервиса.
   * Параметры:

     * `?version=N` (необязательный) — вернуть конкретную версию;
     * `?template=1` — вернуть конфигурацию, обработанную через Jinja2 (пример ниже).
   * Ответ: JSON конфигурация.

3. `GET /config/{service}/history`

   * Назначение: получить список последних версий конфигурации.
   * Ответ: JSON массив объектов вида:

     ```json
     [
       {"version": 1, "created_at": "2025-08-19T12:00:00"},
       {"version": 2, "created_at": "2025-08-19T12:15:00"},
       {"version": 3, "created_at": "2025-08-19T13:00:00"}
     ]
     ```

#### 2.2 Формат конфигурации

* Конфигурация передаётся в YAML:

  ```yaml
  version: 1
  database:
    host: "db.local"
    port: 5432
  features:
    enable_auth: true
    enable_cache: false
  ```

* При запросе с `?template=1` конфигурация должна обрабатываться через Jinja2. Пример:

  ```yaml
  version: 2
  welcome_message: "Hello {{ user }}!"
  ```

  Если при запросе передать `{"user": "Alice"}`, сервис вернёт:

  ```json
  {
    "version": 2,
    "welcome_message": "Hello Alice!"
  }
  ```

#### 2.3 Хранение в БД (Postgres)

Создать таблицу `configurations`:

* `id` (serial, PK)
* `service` (text, not null)
* `version` (integer, not null)
* `payload` (jsonb, not null) — конфигурация в JSON
* `created_at` (timestamp, default now())

Ограничения:

* Версия (`version`) для одного `service` должна быть уникальной.
* При отсутствии версии в YAML она назначается автоматически (`max(version)+1`).

#### 2.4 Ошибки

* Если YAML невалидный → `400 Bad Request` + текст ошибки.
* Если конфигурация не проходит валидацию → `422 Unprocessable Entity` + список ошибок.
* Если сервис не найден → `404 Not Found`.

---

### 3. Нефункциональные требования

1. **Асинхронность**

   * Использовать **Twisted** для реализации API.
   * Запросы не должны блокировать выполнение других задач.

2. **Докеризация**

   * Сервис должен запускаться через **docker-compose**.
   * Состав:

     * контейнер с приложением (Python + Twisted)
     * контейнер с **Postgres**

3. **Качество кода**

   * Код должен быть структурирован (разделение на модули: API, БД, модели, валидация).
   * Использовать типизацию (Python typing).
   * Желательно — тесты (pytest).

